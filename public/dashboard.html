<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="bootstrap-5.3.2-dist/css/bootstrap.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
</head>

<body>
    <div id="show" class="shadow-sm p-3 m-5 my-3">
    </div>
    <div class="my-3 shadow-sm p-3 m-5">
        <h4 class="my-3 text-center">To Do Application</h4>
        <div class="my-2 mx-auto rounded-2 animate__animated animate__rubberBand text-center bg-success text-light w-50"
            style="display: none;" id="save">Saved successfully!üòÅüòÅüòÖ</div>
        <input type="text" placeholder="TO DO" class="my-2 form-control bg-primary text-light shadow-none" id="todo">
        <input type="text" placeholder="TO DO DESCRIPTION" class="my-2 form-control bg-primary text-light shadow-none"
            id="todoDes">
        <input type="file" class="my-2 form-control" id="filey">
        <button class="btn btn-info w-100" onclick="submitTodo()">Submit</button>
        <button class="btn btn-info w-100 my-3" onclick="submitFile()">Submit File</button>
    </div>
    <div id="showy" class="text-center shadow-sm p-3 m-5 my-3">
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, set, onValue, push, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
        import { getStorage, ref as storef, uploadBytesResumable } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

        
        const firebaseConfig = {
            apiKey: "AIzaSyA644UQR5EZhDtk1XYrUxHK0JWUb6mc62I",
            authDomain: "code-test-9329c.firebaseapp.com",
            projectId: "code-test-9329c",
            storageBucket: "code-test-9329c.appspot.com",
            messagingSenderId: "113116940319",
            appId: "1:113116940319:web:5c16ade6bc75e14e8aed2a",
            databaseURL: "https://code-test-9329c-default-rtdb.firebaseio.com",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        const storage = getStorage();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                const uid = user.uid;
                console.log(`user is signed in, ${uid}`);
                console.log(user);
                show.innerHTML = `
                <h1 class=" m-3 text-center">"Welcome to our todo app! <span class="name">${user.displayName}</span> We're delighted to have you here.</h1>
                <div class="">
            <p class="text-center">You email address is ${user.email}</p>
            <div class="text-center">
                Profile Picture:<br>
                <img src="${user.photoURL}" alt="">
            </div>
            </div>
            <button class="btn btn-danger  mt-3" onclick="signO()">sign Out</button>
            `} else {
                console.log('user is signed out');
                window.location.href = 'index.html'
            }
        })
        const signO = () => {
            signOut(auth)
                .then(() => {
                    console.log('Logged Out');
                })
                .catch(() => {
                    console.log('signing out');
                })
        }
        window.signO = signO;

        const submitTodo = () => {
            let time = new Date().toLocaleTimeString()
            let date = new Date().toLocaleDateString()
            // alert("submitted")
            let inputOne = document.getElementById('todo').value
            let inputTwo = document.getElementById('todoDes').value
            let save = document.getElementById('save')

            if (inputOne === '' || inputTwo === '') {
                alert("Fill something inside of me now")
            } else {
                let obj = { time, date, inputOne, inputTwo }
                let dbRef = ref(database, `todos`)
                let newDbRef = push(dbRef)
                let saved = set(newDbRef, obj)
                if (saved) {
                    console.log("Saved successfully");
                    document.getElementById('todo').value = '';
                    document.getElementById('todoDes').value = '';
                    save.style.display = 'block'
                    setTimeout(() => {
                        save.style.display = 'none';
                    }, 8000);
                } else {
                    console.log("failed to save");
                }
            }
        }
        window.submitTodo = submitTodo

        let newRef = ref(database, `todos`);
        onValue(newRef, (snapshot) => {
            let data = snapshot.val();
            console.log(data);

            showy.innerHTML = '';
            // Iterate over each todo item in the data
            for (let key in data) {
                if (data.hasOwnProperty(key)) {
                    let todo = data[key]; // Get the todo object
                    // Append HTML for each todo to the showy element
                    showy.innerHTML += `
                <h5>${todo.inputOne}</h5>
                <h5>${todo.inputTwo}</h5>
                <small>${todo.time}, ${todo.date}</small>
                <button class="btn btn-danger" onclick="deleteTodo('${key}')">Delete</button>
                <br>
            `;
                }
            }
        });

        const deleteTodo = (todoKey) => {
            let todoRef = ref(database, `todos/${todoKey}`);
            remove(todoRef)
                .then(() => {
                    console.log("Todo deleted successfully");
                })
                .catch(error => {
                    console.error("Error deleting todo:", error);
                });
        }
        window.deleteTodo = deleteTodo

        const submitFile = () => {
            // alert('Na file I be o')
            let incomingFile = document.getElementById('filey').files[0]
            console.log(incomingFile);
            onAuthStateChanged(auth, (user) => {
                let filedUser = user.displayName
                console.log(filedUser);
                let storageref = storef(storage, `${filedUser}/${incomingFile.name}`)
                let task = uploadBytesResumable(storageref, incomingFile)
                if (task) {
                    console.log('saved');
                }
            })

        }
        window.submitFile = submitFile
    </script>
</body>

</html>